$(document).ready(function(){if(CL.browser.ieVersion<=7){return;}
var savedSearchTerms=CL.jls.getItem('searchTerms')||[];var storeSearchTerm=function(term){term=normalizeSearchTerm(term);if(term&&savedSearchTerms.indexOf(term)===-1){savedSearchTerms.unshift(term);CL.jls.setItem('searchTerms',savedSearchTerms);}};var removeSearchTerm=function(term){savedSearchTerms=savedSearchTerms.filter(function(sTerm){return sTerm!==term;});CL.jls.setItem('searchTerms',savedSearchTerms);};var normalizeSearchTerm=function(term){return(term||'').trim().replace(/\s+/g,' ').toLowerCase();};var gatherSuggestions=function(request,response,type){var term=normalizeSearchTerm(request.term);var terms=term.split(' ');var makeLabel=function(val,local){var label=val;terms.forEach(function(term){var m=new RegExp("\\b("+$.ui.autocomplete.escapeRegex(term)+")","i");label=label.replace(m,"<b>$1</b>");});if(local){label='<span class="local">'+label+'</span><span class="remove">Remove</span>';}
return{label:label,value:val};};var suggestions=[];var params={v:4,term:term,type:type};var setup={'geo':function(){params.area=window.areaAbb;},'search':function(){params.cat=$("#catAbb").val();params.area=window.areaId||$('#areaID').val();savedSearchTerms.forEach(function(savedItem){var matchedAll=true;terms.forEach(function(term){var m=new RegExp($.ui.autocomplete.escapeRegex(term),'i');if(!savedItem.match(m)){matchedAll=false;}});if(matchedAll){suggestions.push(makeLabel(savedItem,true));}});},'makemodel':function(){}};if(setup[type]){setup[type]();}else{return;}
$.getJSON('/suggest',params).done(function(data){data.forEach(function(item){if(savedSearchTerms.indexOf(item)===-1){suggestions.push(makeLabel(item));}});response(suggestions);});};var select=function(e,ui){if(ui.item.value){var targetChain=e;while(targetChain.originalEvent!==undefined){targetChain=targetChain.originalEvent;}
var $realtarget=$(targetChain.target||targetChain.srcElement);if($realtarget.is('span.remove')){e.preventDefault();removeSearchTerm(ui.item.value);}}};var renderItem=function(ul,item){return $('<li>').data('item.autocomplete',item).append('<a>'+item.label+'</a>').appendTo(ul);};$('[data-suggest]').each(function(i,el){var $this=$(el);var type=$this.data('suggest');var params={source:function(req,res){gatherSuggestions(req,res,type)},minLength:1,delay:100};if(type==='search'){if(!CL.cookies.getItem('cl_b')){return;}
params.select=select;}
$this.autocomplete(params).data('autocomplete')._renderItem=renderItem;});$('form').on('submit',function(){storeSearchTerm($('#query').val());});});